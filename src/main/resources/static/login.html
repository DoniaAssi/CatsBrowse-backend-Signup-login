<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="utf-8" />
    <title>Login — Cats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            crossorigin="anonymous"
    />
    <style>
        body { background-color: #f6fbfc; }
        .login-card { border-radius: 16px; }
        .btn-login { padding:.65rem 1rem; border-radius:12px; }
    </style>
</head>
<body>
<main class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-7 col-lg-5">
            <div class="text-center mt-5 mb-3">
                <h2 class="fw-semibold">Login to Your Account</h2>
            </div>

            <div id="err" class="alert alert-danger d-none" role="alert"></div>

            <div class="card shadow-sm login-card">
                <div class="card-body">
                    <form id="loginForm" novalidate>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input id="email" type="email" class="form-control" placeholder="name@example.com" required />
                            <div class="invalid-feedback">Please enter a valid email.</div>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label d-flex justify-content-between">
                                <span>Password</span>
                                <a href="#" id="togglePass" class="small text-decoration-none">Show</a>
                            </label>
                            <input id="password" type="password" class="form-control" placeholder="••••••••" required />
                            <div class="invalid-feedback">Please enter your password.</div>
                        </div>

                        <button id="doLogin" type="submit" class="btn btn-success w-100 btn-login">
                            <span class="login-text">Login</span>
                            <span class="spinner-border spinner-border-sm ms-2 d-none" aria-hidden="true"></span>
                        </button>
                    </form>

                    <p class="text-center mt-3 mb-0">
                        Don't have an account?
                        <a href="signup.html" class="link-primary">Sign up here.</a>
                    </p>
                </div>
            </div>

            <p class="text-center text-muted mt-3 mb-5 small">© 2025 Cats Browse</p>
        </div>
    </div>
</main>

<script src="auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
    if (typeof isAuthed === 'function' && isAuthed()) {
        window.location.href = '/';
    }

    const form     = document.getElementById('loginForm');
    const emailEl  = document.getElementById('email');
    const passEl   = document.getElementById('password');
    const btn      = document.getElementById('doLogin');
    const spinner  = btn.querySelector('.spinner-border');
    const btnText  = btn.querySelector('.login-text');
    const errEl    = document.getElementById('err');
    const togglePass = document.getElementById('togglePass');

    togglePass.addEventListener('click', (e) => {
        e.preventDefault();
        const isPwd = passEl.type === 'password';
        passEl.type = isPwd ? 'text' : 'password';
        togglePass.textContent = isPwd ? 'Hide' : 'Show';
    });

    function setSubmitting(s) {
        btn.disabled = s;
        spinner.classList.toggle('d-none', !s);
        btnText.textContent = s ? 'Logging in...' : 'Login';
    }

    function showError(msg) {
        errEl.textContent = msg;
        errEl.classList.remove('d-none');
    }
    function hideError() {
        errEl.textContent = '';
        errEl.classList.add('d-none');
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        setSubmitting(true);
        try {
            const email = emailEl.value.trim();
            const password = passEl.value;

            if (typeof login !== 'function') throw new Error('auth.js not loaded');

            const data = await login(email, password);

            if (Array.isArray(data.role) && data.role.includes('ADMIN')) {
                localStorage.setItem('isAdmin', '1');
            } else {
                localStorage.removeItem('isAdmin');
            }

            window.location.href = '/';
        } catch (ex) {
            showError('Wrong email or password.');
            console.error(ex);
        } finally {
            setSubmitting(false);
        }
    });
</script>
</body>
</html>